<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Log Invii</title>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .controls {
      text-align: center;
      margin-bottom: 15px;
    }

    .controls select, .controls input {
      padding: 6px 10px;
      font-size: 14px;
      margin: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 14px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      vertical-align: top;
    }

    th {
      background-color: #eee;
    }

    tr:nth-child(even) {
      background-color: #f7f7f7;
    }

    img.preview {
      max-width: 80px;
      max-height: 80px;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 25px;
      color: #007BFF;
      text-decoration: none;
    }

    #noLogsMessage {
      text-align: center;
      color: #999;
      margin-top: 15px;
    }

    .export-button {
      margin-left: 10px;
      background: #007BFF;
      color: #fff;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
    }

    .export-button:hover {
      background-color: #0056b3;
    }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

  <h1>üìã Log Invii</h1>

  <div class="controls">
    <select id="filtroTipo">
      <option value="">Tutti i tipi</option>
      <option value="email">üìß Email</option>
      <option value="whatsapp">üí¨ WhatsApp</option>
      <option value="sms">üì± SMS</option>
    </select>

    <input type="text" id="filtroData" placeholder="Filtra per data" />

    <button class="export-button" onclick="esportaPDF()">üìÑ Esporta PDF</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Data</th>
        <th>Tipo</th>
        <th>Destinatario</th>
        <th>Rubrica</th>
        <th>Messaggio</th>
        <th>Allegato</th>
      </tr>
    </thead>
    <tbody id="logTableBody"></tbody>
  </table>

  <p id="noLogsMessage" style="display:none;">üïµÔ∏è‚Äç‚ôÇÔ∏è Nessun log trovato.</p>

  <a href="index.html" class="back-link">‚Üê Torna alla Home</a>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const filtroTipo = document.getElementById('filtroTipo');
    const filtroData = document.getElementById('filtroData');
    const tbody = document.getElementById('logTableBody');
    const noLogsMessage = document.getElementById('noLogsMessage');

    flatpickr("#filtroData", {
      dateFormat: "Y-m-d",
      onChange: () => caricaLog()
    });

    filtroTipo.addEventListener('change', () => caricaLog());

    function caricaLog() {
      const tipo = filtroTipo.value;
      const data = filtroData.value;
      let url = '/api/log';
      if (tipo || data) {
        const params = [];
        if (tipo) params.push(`tipo=${tipo}`);
        url += '?' + params.join('&');
      }

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const logs = filtroData.value
            ? data.filter(log => log.data.startsWith(filtroData.value))
            : data;

          tbody.innerHTML = '';
          noLogsMessage.style.display = logs.length === 0 ? 'block' : 'none';

          logs.forEach(log => {
            const tr = document.createElement('tr');
            const ext = log.allegato?.split('.').pop().toLowerCase();
            let allegatoHTML = '';
            if (ext && ['jpg', 'jpeg', 'png'].includes(ext)) {
              allegatoHTML = `<a href="/${log.allegato}" target="_blank"><img src="/${log.allegato}" class="preview"></a>`;
            } else if (ext === 'pdf') {
              allegatoHTML = `<a href="/${log.allegato}" target="_blank">üìÑ PDF</a>`;
            } else if (log.allegato) {
              allegatoHTML = `<a href="/${log.allegato}" target="_blank">üìé File</a>`;
            }

            tr.innerHTML = `
              <td>${log.id}</td>
              <td>${log.data}</td>
              <td>${log.tipo}</td>
              <td>${log.destinatario}</td>
              <td>${log.rubrica}</td>
              <td>${log.messaggio}</td>
              <td>${allegatoHTML}</td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    function esportaPDF() {
      import('jspdf').then(jsPDF => {
        const doc = new jsPDF.jsPDF();
        doc.setFontSize(10);
        doc.text("Log Invii", 10, 10);
        let y = 20;
        const rows = document.querySelectorAll('#logTableBody tr');
        rows.forEach((tr, i) => {
          const cols = tr.querySelectorAll('td');
          let text = '';
          cols.forEach(td => {
            text += td.innerText.replace(/\n/g, ' ') + ' | ';
          });
          doc.text(text.slice(0, -3), 10, y);
          y += 8;
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
        });
        doc.save("log-invii.pdf");
      });
    }

    caricaLog();
  </script>
</body>
</html>
